# Creating an MCM model

## The default model
The first step to using MCMSEM is to generate a model object. This object stores all the required matrices and settings for you. The default
``` 
my_model <- MCMmodel(dataset)
```

By default, this will create the model below.

![Figure 1](../imgs/2.1.Figure1.SVG)

This default model includes the following:
 - Variances, skewness and kurtosis for observed variables (not shown in the figure to prevent crowding it even more).
 - One latent factor (`f1`)
 - One free pramater (`a1`) for each of the paths from the latent factor to the observed variables
 - All causal paths between the observed traits, where `bx_y` represents the causal path from variable `x` to variable `y`. Note not all labels are included in the figure.

> **Tip**: You can always obtain a similar visualization of your own model by running `plot(my_model)`

## Multiple factor models
We imagine that in many cases the default model will not be the exact model you want to run. You will likely want to change a number of things. For example, the number of latent factors. 
To do this, use the `n_latent` argument in `MCMmodel`:
``` 
my_model <- MCMmodel(dataset, n_latent=2)
```

This will create the following model.

![Figure 2](../imgs/2.1.Figure2.SVG)
 
This model includes two latent factors (`f1` and `f2`) with two free parameters,`a1` and `a2`, for all paths from `f1` and all paths from `f2` respectively to all the observed variables.
Apart from that, the model is identical to the default model.

> **Note**: Almost everything about the model can be changed through `MCMedit` (See section 2.2 Editing an MCM model), but the number of latent factors is the exception. This is fixed once the model is generated. 

## Free factor loading
By seting `constrained_a` to `FALSE` one parameter is fitted for each latent factor for each variable (so a total of `n_latent`*`n_variables` free parameters.
```
my_model <- MCMmodel(dataset, constrained_a=FALSE)
```

This will create the following model.

![Figure 3](../imgs/2.1.Figure3.SVG)
 
Note that this model contains 5 (i.e. the number of observed variables) free parameters instead of 1 (`a1` in the default model): `ax_y` where x is the factor number and y is the observed variable number.

> **Tip**: You can combine `n_latent` and `constrained_a` to your hearts content. But keep in mind that the number of parameters quickly balloons in larger models when doing this.

## Latent causal paths
In some cases you might be more interested in the relationship between latent factors than in the relationship between observed variables.
In that case you might want to estimate the causal paths between the latent factors as opposed to those between the observed variables. To do this use `causal_latent` and `causal_observed`
```
my_model <- MCMmodel(dataset, n_latent=2, causal_latent=TRUE, causal_observed=FALSE)
```

This will create the following model.

![Figure 4](../imgs/2.1.Figure4.SVG)

In this model causal paths between the observed traits are no longer estimated, and instead parameters `blx_y` are included which represent the causal path of factor `x` on factor `y`.

> **Tip**: The arguments `var_latent`, `var_observed`, `skew_latent`, `skew_observed`, `kurt_latent`, `kurt_latent` work similarly for variance, skewness and kurtosis respectively. Consider using a combination of them to obtain the best model.

## Advanced
> :warning: __WARNING__: The following information is intended for very advanced users only. Basic and advanced changed to your MCM model should always be performed through `MCMedit` (see 2.2 Editing an MCM model).

The MCM model object is an R6 object of class `mcmmodelclass`, meaning objects within it are modified in place. If you ever want to make changes to your model without MCMedit (again, this is not recommended), it is recomended to do so in a hardcopy of the model object: `modelcopy <- my_model$copy()`
The MCM model object contains the following objects:
 - `named_matrices`: List of A, Fm, S, Sk and K matrices of type `character` detailing the position of free parameters in the matrices
 - `num_matrices`: List of A, Fm, S, Sk, and K matrices of type `numeric`. At model inception these matrices will hold only starting values, after `MCMfit` these will hold the actual estimates.
 - `param_names`: Vector of type `character` containing names of all free parameters
 - `param_values`: Vector of type `numeric` containing numeric values of the free parameters
 - `param_coords`: List of length `n_parameters`. Each element in this details the following for each of the parameters (1) source matrix name, (2): 1D-coordinates, (3): multiplier (allowing for e.g. `-a1` to be used)
 - `start_values`: Dataframe with 1 row and `n_parameters` columns containing starting values for each parameter
 - `bounds`: Dataframe with 2 rows (`L` and `U`) and `n_parameters` columns containing lower and upper bounds respectively for each free parameter
 - `meta_data`: Model meta data, list containing the following:
   - `n_obs`: nrow(data)
   - `n_phenotypes`: N observed phenotypes
   - `n_latent`: N latent factors
   - `bound_defaults`: Default values for bounds
   - `data_was_scaled`: TRUE if the input data was already scaled, otherwise FALSE
   - `scale_data`: TRUE if data should be scaled, otherwise FALSE
   - `original_colnames`: Original column names of the input data (for table and plot purposes)
   - `latent_names`: Automatically generated or user input latent factor names (for table and plot purposes) 

The MCM model object contains the following methods:
 - `copy`: Returns a deep copy of the `mcmmodelclass` object
 - `initialize`: Initializes a new `mcmmodelclass` instance
 - `show`: Returns the default visualization of the `mcmmodelclass` object (the A, Fm and S matrices), executed upon `my_model` and `print(my_model)`
 - `parse`: Parse changes made to the model via `MCMedit`: Updates the underlying structure (start values, bounds, param_coords, etc) depending on changes made.